# CLI Music Player - 产品需求文档 (PRD)

## 1. 项目概述

### 1.1 项目背景
一个基于命令行的本地音乐播放器，提供沉浸式的终端音乐播放体验，支持可视化音频波形和可扩展的主题系统。

### 1.2 项目目标
- 提供简洁高效的命令行音乐播放体验
- 实现实时的音频波形可视化
- 支持插件化的主题系统，允许用户自定义界面风格
- 跨平台支持（macOS、Linux、Windows）

### 1.3 目标用户
- 终端爱好者和开发者
- 喜欢轻量级工具的用户
- 需要在工作时听音乐的命令行用户

---

## 2. 功能需求

### 2.1 核心播放功能

#### 2.1.1 音频播放
- [ ] 支持主流音频格式：MP3、FLAC、WAV、AAC、OGG
- [ ] 播放控制：播放、暂停、停止、上一首、下一首
- [ ] 进度控制：跳转、快进/快退（10秒步进）
- [ ] 音量控制：音量增减、静音切换
- [ ] 播放模式：顺序播放、随机播放、单曲循环、列表循环

#### 2.1.2 播放列表管理
- [ ] 创建、保存、加载播放列表（M3U/JSON格式）
- [ ] 添加文件/文件夹到播放列表
- [ ] 从播放列表移除歌曲
- [ ] 播放列表排序（名称、艺术家、时长、自定义）
- [ ] 搜索和过滤播放列表

#### 2.1.3 元数据显示
- [ ] 读取并显示音频文件元数据（ID3标签）
- [ ] 显示信息：标题、艺术家、专辑、年份、流派、封面
- [ ] 显示音频技术信息：比特率、采样率、声道数、时长

### 2.2 界面显示功能

#### 2.2.1 主界面布局
```
┌─────────────────────────────────────────────────────────┐
│  [主题装饰线]                                            │
│  ♪ Now Playing: Song Title - Artist                     │
│  [=========>          ]  2:34 / 4:56                     │
│  [音频波形可视化区域]                                     │
│  ┌─────────────────────────────────────────────────┐   │
│  │    ∿∿∿∿ ∿∿∿∿∿ ∿∿∿∿∿∿ ∿∿∿∿ ∿∿∿∿∿∿ ∿∿∿∿∿       │   │
│  │    ∿∿∿∿∿ ∿∿∿∿ ∿∿∿∿∿ ∿∿∿∿∿ ∿∿∿∿ ∿∿∿∿∿∿∿       │   │
│  └─────────────────────────────────────────────────┘   │
│  [播放控制按钮]  🔀 🔁 ⏮ ⏯ ⏭                            │
│  Vol: [████░░░░░░] 70%  │  Playlist (12/156)            │
│  [主题装饰线]                                            │
└─────────────────────────────────────────────────────────┘
```

#### 2.2.2 界面组件
- [ ] **状态栏**：显示播放状态、当前时间/总时长
- [ ] **进度条**：可交互的播放进度显示
- [ ] **音量条**：可视化音量控制
- [ ] **播放列表面板**：可滚动歌曲列表，当前歌曲高亮
- [ ] **帮助面板**：快捷键提示
- [ ] **通知/消息区域**：操作反馈、错误提示

### 2.3 音频波形显示

#### 2.3.1 波形类型
- [ ] **频谱分析仪**：FFT频谱柱状图（多频段）
- [ ] **波形图**：时域波形显示（左右声道）
- [ ] **圆形/径向可视化**：圆形频谱或波形
- [ ] **粒子效果**：基于音频的动态粒子动画

#### 2.3.2 波形配置
- [ ] 刷新率：30fps / 60fps 可选
- [ ] 平滑度：波形平滑处理级别
- [ ] 颜色：支持主题定义的颜色方案
- [ ] 灵敏度：音频响应敏感度调节

### 2.4 主题系统（插件化）

#### 2.4.1 主题架构
```
themes/
├── default/           # 默认主题
│   ├── theme.yaml    # 主题配置文件
│   ├── colors.py     # 颜色定义
│   └── layout.py     # 布局定义
├── neon/             # 霓虹主题（示例）
├── minimal/          # 极简主题（示例）
└── retro/            # 复古主题（示例）
```

#### 2.4.2 主题配置内容
- [ ] **颜色方案**：主色、次色、背景色、高亮色、警告色
- [ ] **字符集**：边框样式、进度条字符、波形字符
- [ ] **布局配置**：各面板位置、大小、可见性
- [ ] **动画效果**：过渡效果、刷新行为
- [ ] **波形样式**：波形颜色、高度、样式变体

#### 2.4.3 主题管理
- [ ] 内置主题：default、neon、minimal、retro、ocean
- [ ] 主题切换：运行时切换，无需重启
- [ ] 自定义主题：用户可创建和导入自定义主题
- [ ] 主题市场/分享：主题文件的导入导出

---

## 3. 命令与快捷键

### 3.1 全局快捷键
| 按键 | 功能 |
|------|------|
| `Space` | 播放/暂停 |
| `→` / `←` | 快进/快退 10秒 |
| `↑` / `↓` | 音量增减 |
| `n` / `p` | 下一首/上一首 |
| `m` | 静音切换 |
| `s` | 切换随机播放 |
| `r` | 切换循环模式 |
| `q` / `Esc` | 退出程序 |
| `?` / `h` | 显示帮助 |
| `t` | 切换主题 |

### 3.2 播放列表快捷键
| 按键 | 功能 |
|------|------|
| `l` | 显示/隐藏播放列表 |
| `j` / `k` | 播放列表上下移动（vim风格） |
| `Enter` | 播放选中歌曲 |
| `d` | 从播放列表删除选中歌曲 |
| `/` | 搜索播放列表 |

### 3.3 命令行参数
```bash
# 基本使用
cmp <file.mp3>                    # 播放单个文件
cmp <playlist.m3u>                # 加载播放列表
cmp /path/to/music/folder         # 加载文件夹

# 选项
cmp --theme <theme_name>          # 指定主题启动
cmp --no-visualizer               # 禁用可视化
cmp --config <config_path>        # 指定配置文件
cmp --help                        # 显示帮助
```

---

## 4. 非功能需求

### 4.1 性能要求
- [ ] CPU占用：播放时 < 5%，可视化开启时 < 15%
- [ ] 内存占用：< 100MB（不含大型播放列表）
- [ ] 启动时间：< 2秒
- [ ] 响应延迟：快捷键响应 < 50ms

### 4.2 兼容性
- [ ] Python 3.8+
- [ ] 支持终端：iTerm2、Terminal、Windows Terminal、Alacritty、Kitty
- [ ] 支持 True Color 和 256色终端
- [ ] 自动检测终端能力，优雅降级

### 4.3 可靠性
- [ ] 异常音频文件处理，不崩溃
- [ ] 自动保存播放进度（可选）
- [ ] 配置文件容错（损坏配置自动恢复默认值）

---

## 5. 技术选型

### 5.1 核心依赖
| 组件 | 选型 | 说明 |
|------|------|------|
| 音频播放 | `pyaudio` + `soundfile` / `pydub` | 音频播放和处理 |
| 元数据读取 | `mutagen` | 音频标签读取 |
| 终端UI | `rich` / `textual` | 富文本界面组件 |
| TUI框架 | `textual` | 终端用户界面框架 |
| 音频分析 | `numpy` + `scipy` | FFT和信号处理 |
| 配置管理 | `pydantic` + `yaml` | 配置验证和解析 |

### 5.2 可选依赖
- `ueberzug` / `viu`：终端图片显示（专辑封面）
- `lyricsgenius`：歌词获取（未来扩展）

---

## 6. 架构设计

### 6.1 模块划分
```
cli_music_player/
├── __main__.py          # 入口点
├── app.py               # 主应用逻辑
├── config/              # 配置管理
│   ├── settings.py
│   └── manager.py
├── player/              # 音频播放核心
│   ├── engine.py        # 播放引擎
│   ├── playlist.py      # 播放列表管理
│   └── metadata.py      # 元数据读取
├── ui/                  # 用户界面
│   ├── app.tcss         # Textual CSS样式
│   ├── screens/         # 界面屏幕
│   ├── widgets/         # 自定义组件
│   └── themes/          # 主题管理
├── visualizer/          # 音频可视化
│   ├── base.py          # 可视化基类
│   ├── spectrum.py      # 频谱分析器
│   ├── waveform.py      # 波形显示
│   └── circular.py      # 圆形可视化
├── themes/              # 内置主题
│   ├── default/
│   ├── neon/
│   └── ...
└── utils/               # 工具函数
    ├── audio_utils.py
    └── helpers.py
```

### 6.2 数据流
```
音频文件 → 解码 → 播放缓冲区 → 音频输出
                ↓
            采样数据 → FFT分析 → 可视化渲染
                ↓
            元数据读取 → UI更新
```

---

## 7. 配置设计

### 7.1 配置文件位置
```
~/.config/cmp/
├── config.yaml          # 主配置文件
├── playlists/           # 播放列表存储
├── themes/              # 用户自定义主题
└── cache/               # 缓存数据（封面、波形数据等）
```

### 7.2 配置项
```yaml
# config.yaml
player:
  default_volume: 70
  remember_position: true
  auto_play: false
  
playlist:
  default_sort: "name"  # name, artist, album, custom
  recursive_add: true
  
visualizer:
  enabled: true
  type: "spectrum"      # spectrum, waveform, circular
  fps: 30
  sensitivity: 1.0
  
theme:
  name: "default"
  custom_path: null
  
keybindings:
  # 可自定义快捷键
  quit: "q"
  play_pause: "space"
  # ...
```

---

## 8. 开发计划

### 8.1 里程碑
| 阶段 | 目标 | 预计工期 |
|------|------|----------|
| M1 | 基础框架、音频播放核心 | 1周 |
| M2 | 基础UI界面、播放列表 | 1周 |
| M3 | 音频可视化 | 1周 |
| M4 | 主题系统 | 1周 |
| M5 | 测试优化、文档 | 1周 |

### 8.2 M1 详细任务
- [ ] 项目脚手架搭建
- [ ] 音频播放引擎（pyaudio）
- [ ] 基础播放控制
- [ ] 元数据读取
- [ ] 命令行参数解析

### 8.3 M2 详细任务
- [ ] Textual TUI框架集成
- [ ] 主界面布局
- [ ] 播放列表管理
- [ ] 快捷键系统
- [ ] 配置文件管理

### 8.4 M3 详细任务
- [ ] FFT音频分析
- [ ] 频谱可视化
- [ ] 波形可视化
- [ ] 性能优化

### 8.5 M4 详细任务
- [ ] 主题系统架构
- [ ] 内置主题实现
- [ ] 主题加载/切换
- [ ] 用户自定义主题支持

### 8.6 M5 详细任务
- [ ] 单元测试
- [ ] 集成测试
- [ ] 性能调优
- [ ] 用户文档
- [ ] 打包发布

---

## 9. 风险与挑战

### 9.1 技术风险
| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 跨平台音频兼容性 | 高 | 使用成熟的跨平台库，充分测试 |
| 终端兼容性 | 中 | 提供配置选项，优雅降级 |
| 高性能可视化 | 中 | 优化算法，控制刷新率 |

### 9.2 依赖风险
- Python GIL可能限制音频处理和UI的并发性能
- 某些终端对特殊字符支持有限

---

## 10. 未来扩展

### 10.1 可能的增强功能
- [ ] 歌词显示（LRC文件支持）
- [ ] 在线歌词获取（API集成）
- [ ] 网络流媒体播放（HTTP stream）
- [ ] 媒体库管理（数据库索引）
- [ ] 插件系统（Python插件）
- [ ] 远程控制（WebSocket API）
- [ ] 音效均衡器
- [ ] 交叉淡入淡出

---

## 11. 附录

### 11.1 参考项目
- `cmus` - 命令行音乐播放器
- `mpv` - 媒体播放器
- `cava` - 终端音频可视化
- `musikcube` - 终端音乐播放器

### 11.2 术语表
- **TUI**: Text-based User Interface，文本用户界面
- **FFT**: Fast Fourier Transform，快速傅里叶变换
- **ID3**: MP3文件的元数据标签标准
