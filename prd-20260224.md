# CMP 功能增强 PRD - 2026-02-24

## 1. 功能概述

本次开发旨在增强 CLI 音乐播放器的视觉体验，新增：
- **多可视化效果系统**：支持多种音频可视化效果，可快速切换
- **可切换布局系统**：支持多种界面布局，适应不同使用场景

---

## 2. 可视化效果系统

### 2.1 目标可视化效果调研

基于终端字符界面的限制和现有技术，规划以下可视化效果：

#### 已实现 ✅
| 效果名称 | 描述 | 复杂度 |
|---------|------|--------|
| **spectrum** | 频谱柱状图（现有） | 已完成 |
| **waveform** | 波形图（现有） | 已完成 |
| **compact** | 单行频谱（现有） | 已完成 |

#### 计划新增 🆕
| 效果名称 | 描述 | 复杂度 | 优先级 |
|---------|------|--------|--------|
| **circle** | 圆形/径向频谱，能量从中心向外辐射 | 中 | P0 |
| **particles** | 粒子效果，音频触发粒子跳动 | 中 | P1 |
| **oscilloscope** | 复古示波器风格，左右声道分别显示 | 低 | P1 |
| **stereo** | 立体声分离显示，左右声道频谱并排 | 低 | P0 |
| **mirror** | 镜像频谱，上下对称显示 | 低 | P0 |
| **waterfall** | 瀑布图/频谱历史，频谱随时间向下滚动 | 高 | P2 |
| **lissajous** | 李萨如图形，立体声相位可视化 | 中 | P2 |

### 2.2 可视化效果详细设计

#### Circle - 圆形频谱
```
           ██
       ████████
     ████████████
    ██████████████
   ████████████████
    ██████████████
     ████████████
       ████████
           ██
```
- 32 个频段均匀分布在 360° 圆周
- 使用不同字符表示能量强度：`·∘○◯●`
- 支持顺时针/逆时针旋转动画

#### Stereo - 立体声分离
```
左声道: ████████░░░░░░░░ 右声道: ░░░░░░░░████████
```
- 左右声道分别计算 FFT
- 并排显示两个频谱柱状图
- 宽度自动适配

#### Mirror - 镜像频谱
```
          ▓▓  ▓▓
        ▓▓▓▓▓▓▓▓
      ▓▓▓▓▓▓▓▓▓▓▓▓
    ░░▓▓▓▓▓▓▓▓▓▓▓▓░░
  ░░░░▓▓▓▓▓▓▓▓▓▓▓▓░░░░
░░░░░░▓▓▓▓▓▓▓▓▓▓▓▓░░░░░░
```
- 频谱上下对称显示
- 上半部分使用暖色字符，下半部分使用冷色字符

#### Oscilloscope - 示波器
```
     ╱╲      ╱╲
╱╲  ╱  ╲  ╱  ╲  ╱╲
  ╲╱    ╲╱    ╲╱
```
- 类似老式示波器的波形显示
- 使用 `╱╲╳` 等 Unicode 框线字符
- 可切换单声道/立体声双轨

### 2.3 交互设计

#### 快捷键
- `v` - 循环切换可视化效果（保留现有）
- `V` (Shift+v) - 反向切换
- `Ctrl+V` - 打开可视化选择菜单

#### 偏好设置
配置文件 `config.yaml`：
```yaml
visualizer:
  enabled: true
  type: "spectrum"           # 默认类型
  fps: 30
  sensitivity: 1.0
  bar_count: 32
  smoothing: 0.3
  available_types:           # 用户可启用的类型
    - "spectrum"
    - "circle"
    - "stereo"
    - "waveform"
    - "mirror"
```

---

## 3. 布局样式系统

### 3.1 布局样式调研

| 布局名称 | 描述 | 适用场景 | 优先级 |
|---------|------|---------|--------|
| **default** | 默认布局（现有） | 均衡体验 | 已有 |
| **compact** | 紧凑布局，隐藏可视化 | 小终端/专注听歌 | P0 |
| **visual** | 视觉优先，最大化可视化 | 展示/氛围 | P0 |
| **playlist** | 播放列表优先 | 管理大量歌曲 | P0 |
| **minimal** | 极简，仅显示歌曲信息和控制 | 后台播放 | P1 |
| **split** | 左右分栏，播放列表+主界面 | 宽屏终端 | P1 |

### 3.2 布局详细设计

#### Default - 默认布局（现有）
```
┌─────────────────────────────────┐
│ CMP - CLI Music Player          │  Header (3行)
│ 艺术家 - 歌曲标题                │
│ 01:23 / 03:45                   │
├─────────────────────────────────┤
│                                 │  Visualizer (10行)
│      [频谱可视化区域]            │
│                                 │
├─────────────────────────────────┤
│ ████████████░░░░░░░░░░░░░░░░   │  Progress (1行)
├─────────────────────────────────┤
│ [⏮] [▶] [⏭]  🔀  🔁    Vol: ████░░░░░░ │  Controls (3行)
├─────────────────────────────────┤
│ 1. Song A                    ● │  Playlist (1fr)
│ 2. Song B                      │
├─────────────────────────────────┤
│ Ready | Vol:70% | Theme:neon    │  Status (1行)
└─────────────────────────────────┘
```

#### Compact - 紧凑布局
```
┌─────────────────────────────────┐
│ 艺术家 - 歌曲标题     01:23/03:45│
├─────────────────────────────────┤
│ [⏮] [▶] [⏭]  🔀  🔁    Vol:████░ │
├─────────────────────────────────┤
│ 1. Song A   2. Song B   3. Song │  Playlist (单行滚动)
└─────────────────────────────────┘
```
- 总高度 5-6 行
- 隐藏可视化
- 单行滚动播放列表

#### Visual - 视觉优先
```
┌─────────────────────────────────┐
│                                 │
│                                 │
│      [大型可视化区域]            │  Visualizer (15行)
│                                 │
│                                 │
├─────────────────────────────────┤
│ ████████████░░░░░░░░░░░░░░░░   │
├─────────────────────────────────┤
│ 艺术家 - 歌曲标题    01:23/03:45│
│ [⏮] [▶] [⏭]              Vol ░░│
└─────────────────────────────────┘
```
- 可视化区域最大化
- 控制信息压缩到底部

#### Playlist - 播放列表优先
```
┌─────────────────────────────────┐
│ CMP - CLI Music Player          │
├─────────────────────────────────┤
│ #  歌曲            艺术家   时长 │
│ ─────────────────────────────── │
│ 1  Song A          Artist  3:45 │
│ 2  Song B          Artist  4:12 │  Playlist (12行)
│ ●3 Song C          Artist  2:58 │  (当前播放高亮)
│ 4  Song D          Artist  3:30 │
│ ...                             │
├─────────────────────────────────┤
│ [⏮] [▶] [⏭]    01:23 / 03:45   │
└─────────────────────────────────┘
```
- 播放列表占主导
- 显示更多信息（序号、标题、艺术家、时长）
- 当前歌曲高亮显示

#### Minimal - 极简布局
```
艺术家 - 歌曲标题 [▶] 01:23/03:45
```
- 单行显示
- 适合后台播放或与其他工具配合

#### Split - 左右分栏（宽屏）
```
┌────────────────────┬────────────┐
│                    │ 播放列表    │
│                    │ 1. Song A  │
│    [可视化]         │ 2. Song B  │
│                    │ 3. Song C  │
│                    │ ...        │
├────────────────────┼────────────┤
│ ████████░░░░░░░░░░ │ 进度条     │
├────────────────────┴────────────┤
│ [⏮] [▶] [⏭]    01:23/03:45     │
└─────────────────────────────────┘
```
- 需要终端宽度 >= 120
- 左侧主区域，右侧播放列表
- 自适应窄屏时回退到默认布局

### 3.3 交互设计

#### 快捷键
- `L` - 循环切换布局（保留现有切换播放列表显示）
- `Ctrl+L` - 打开布局选择菜单

#### 偏好设置
```yaml
interface:
  layout: "default"          # 默认布局
  auto_layout: true          # 根据终端大小自动切换
  min_width_for_split: 120   # split 布局最小宽度
  compact_height_threshold: 20  # 小于此高度自动使用 compact
```

---

## 4. 技术方案

### 4.1 可视化效果实现

```
cmp/visualizer/
├── base.py              # 基类（已有）
├── spectrum.py          # 频谱（已有）
├── waveform.py          # 波形（已有）
├── circle.py            # 圆形频谱 🆕
├── stereo.py            # 立体声分离 🆕
├── mirror.py            # 镜像频谱 🆕
├── oscilloscope.py      # 示波器 🆕
└── manager.py           # 可视化管理器 🆕
```

**新增文件说明：**
- `manager.py`: 管理所有可视化效果，负责注册、切换、获取实例
- `circle.py`: 圆形频谱实现
- `stereo.py`: 立体声分离频谱
- `mirror.py`: 镜像对称频谱
- `oscilloscope.py`: 示波器风格波形

### 4.2 布局系统实现

```
cmp/ui/
├── app.py               # 主应用（修改）
├── layouts/             # 布局系统 🆕
│   ├── base.py          # 布局基类
│   ├── default.py       # 默认布局
│   ├── compact.py       # 紧凑布局
│   ├── visual.py        # 视觉优先
│   ├── playlist.py      # 播放列表优先
│   ├── minimal.py       # 极简布局
│   └── split.py         # 左右分栏
├── screens/             # 屏幕组件 🆕
│   └── player_screen.py # 播放器屏幕（从 app.py 迁移）
└── widgets/             # UI 组件（已有）
```

### 4.3 配置更新

`config/settings.py` 新增配置项：
```python
class VisualizerConfig(BaseModel):
    enabled: bool = True
    type: str = "spectrum"
    available_types: List[str] = ["spectrum", "circle", "stereo", "waveform", "mirror"]
    # ... 其他配置

class InterfaceConfig(BaseModel):
    layout: str = "default"
    auto_layout: bool = True
    min_width_for_split: int = 120
    compact_height_threshold: int = 20
    show_notifications: bool = True
```

---

## 5. 界面设计

### 5.1 可视化选择弹窗

```
┌─────────────────────────┐
│    选择可视化效果        │
├─────────────────────────┤
│  ● 频谱 (spectrum)      │
│    波形 (waveform)      │
│    圆形 (circle)        │
│    立体声 (stereo)      │
│    镜像 (mirror)        │
│    示波器 (oscilloscope) │
├─────────────────────────┤
│  [预览]  [确认]  [取消] │
└─────────────────────────┘
```

### 5.2 布局选择弹窗

```
┌─────────────────────────┐
│    选择布局样式          │
├─────────────────────────┤
│  ● 默认 (Default)       │
│    紧凑 (Compact)       │
│    视觉 (Visual)        │
│    列表 (Playlist)      │
│    极简 (Minimal)       │
│    分栏 (Split)         │
├─────────────────────────┤
│  [预览]  [确认]  [取消] │
└─────────────────────────┘
```

---

## 6. 实现计划

### 阶段一：可视化效果系统（3-4 小时）
1. **创建可视化管理器** (`visualizer/manager.py`)
   - 注册/获取可视化效果
   - 切换逻辑
   
2. **实现圆形频谱** (`visualizer/circle.py`)
   - 极坐标转换
   - 字符渲染
   
3. **实现立体声分离** (`visualizer/stereo.py`)
   - 左右声道分别处理
   
4. **实现镜像频谱** (`visualizer/mirror.py`)
   - 对称渲染
   
5. **更新 UI 集成**
   - 快捷键支持
   - 偏好菜单

### 阶段二：布局系统（3-4 小时）
1. **创建布局基类和架构** (`ui/layouts/base.py`)
   
2. **实现紧凑布局** (`ui/layouts/compact.py`)
   - 最简单，作为验证
   
3. **实现视觉布局** (`ui/layouts/visual.py`)
   
4. **实现播放列表布局** (`ui/layouts/playlist.py`)
   
5. **实现极简布局** (`ui/layouts/minimal.py`)
   
6. **实现分栏布局** (`ui/layouts/split.py`)
   - 最复杂，需要检测终端尺寸

### 阶段三：集成与优化（2 小时）
1. 配置系统集成
2. 快捷键和菜单
3. 自动布局切换
4. 测试和调优

---

## 7. 待确认事项

请确认以下内容：

### 7.1 可视化效果
- [ ] 新增的效果是否满足需求？
- [ ] 是否需要其他效果？
- [ ] 是否支持自定义颜色主题？

### 7.2 布局系统
- [ ] 6 种布局是否足够？
- [ ] 是否需要自动根据终端尺寸切换布局？
- [ ] Split 布局的最小宽度阈值设置多少合适？

### 7.3 交互方式
- [ ] 快捷键方案是否合适？
- [ ] 是否需要保存每种布局的最后状态？
- [ ] 是否需要动画过渡效果？

### 7.4 优先级
- [ ] 是否先实现可视化，再实现布局？
- [ ] 还是两个功能并行开发？

---

## 8. 附录

### 8.1 字符集参考

**块状字符：**
```
_ ▁ ▂ ▃ ▄ ▅ ▆ ▇ █  # 8级高度
░ ▒ ▓               # 密度
```

**框线字符：**
```
─ │ ┌ ┐ └ ┘ ├ ┤ ┬ ┴ ┼
═ ║ ╔ ╗ ╚ ╝ ╠ ╣ ╦ ╩ ╬
╱ ╲ ╳
```

**圆形相关：**
```
· ∘ ○ ◯ ● ◐ ◑ ◒ ◓
```

### 8.2 性能考虑

- FFT 计算在独立线程进行
- 渲染频率限制为 30fps
- 复杂效果（如粒子）需要限制粒子数量
- 终端尺寸变化时重新计算布局
